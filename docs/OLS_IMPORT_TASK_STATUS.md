# Задача: автоматизация построения однолинейки из Excel

Обновлено: 2026-03-01

## Что нужно получить

Стабильный поток:

1. `EOM_ИМПОРТ_EXCEL` получает валидные строки.
2. `EOM_ПОСТРОИТЬ_ОЛС` строит однолинейку по этим строкам.
3. Пользователь не делает ручной перенос данных из Excel в AutoCAD.

## Что я пытаюсь сделать

Сделать импорт предсказуемым и прозрачным:

- чтобы было видно, **из какого источника** читаются данные (`OUTPUT.csv` или книга `xlsx`);
- чтобы fallback по книге `В Акад` работал, когда `OUTPUT.csv` нет;
- чтобы ошибки чтения отдельных формул/ячеек не обнуляли весь импорт.

## Что уже внедрено

1. Добавлена команда `EOM_EXCEL_PATH` + кнопка `Путь Excel` в Ribbon.
2. Добавлен fallback чтения из книги (`В Акад`) через `ClosedXML`.
3. Добавлена диагностика в логах `EOM_ИМПОРТ_EXCEL`:
   - `template=...`
   - `output=...`
   - `output_exists=...`
   - `workbook_exists=...`
   - выбранный источник импорта.
4. Усилен парсер workbook:
   - чтение формульных ячеек через `CachedValue` в приоритете;
   - мягкий поиск листа `В Акад`;
   - безопасная обработка проблемных строк.

## Что сейчас видно по факту

По вашему логу:

- `output_exists=False`
- `workbook_exists=True`
- источник: fallback из книги `...Однолинейка ЩР ЭОМ.xlsx`, лист `В Акад`
- итог: `Строк: 0`

Это значит: источник выбран правильно, но в рантайме AutoCAD строки не проходят фильтр валидности.

## Что такое "валидная строка" в текущем коде

Строка листа `В Акад` (с 3-й строки), где:

- D (`Щит`) значимое;
- E (`Номер линии`) значимое и не `0`;
- M (`Кабель`) значимое;
- значения не начинаются с `#` и `=`;
- это не заголовки (`Щит`, `Номер линии`, `Кабель`).

## Почему это тормозит автоматизацию сейчас

Пока импорт дает `0`, `EOM_ПОСТРОИТЬ_ОЛС` не имеет входных строк, поэтому автоматизация не срабатывает.

## Практичный рабочий путь (рекомендую)

Сделать основной режим `CSV-first / CSV-only`:

1. Генерировать и использовать `*.OUTPUT.csv` как основной контракт.
2. `xlsx` оставить только как диагностический/аварийный fallback.
3. При отсутствии CSV выдавать очень явное сообщение с нужным путем и форматом.

Это даст стабильный промышленный процесс без зависимости от особенностей чтения формул в host-процессе AutoCAD.

## Следующий шаг

Если подтверждаете, делаю правку:

- режим `CSV-only` для `EOM_ИМПОРТ_EXCEL`;
- понятные ошибки и чек-лист в лог;
- `xlsx` fallback отключаем (или оставляем флагом в настройках).
